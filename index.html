<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Firefly Habitat Zoning — GIS + Random Forest (HTML/JS)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- PapaParse for CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- Turf.js for light geoprocessing (buffer, bbox grid, etc.) -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>

  <!-- Random Forest (ml.js) -->
  <script src="https://cdn.jsdelivr.net/npm/ml-random-forest@4.1.1/dist/ml-random-forest.min.js"></script>

  <style>
    :root {
      --bg:#0b0f14; --panel:#121821; --accent:#3fb3ff; --text:#e7eef8; --muted:#90a4b8;
      --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --border:#1f2733;
    }
    html,body {height:100%;margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;}
    .layout {display:grid;grid-template-columns:340px 1fr;grid-template-rows:56px 1fr;height:100%;}
    header {grid-column:1/3;display:flex;align-items:center;justify-content:space-between;padding:0 16px;background:#0d141c;border-bottom:1px solid var(--border);z-index:10;}
    header h1 {font-size:16px;margin:0;font-weight:600;}
    header .mini {opacity:.8;font-size:12px;}
    aside {border-right:1px solid var(--border);background:var(--panel);overflow:auto;z-index:5;}
    main {position:relative;z-index:1;}
    #map {position:absolute;inset:0;z-index:1;}
    .panel {padding:14px 14px 80px;}
    .group {border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:12px;background:#0f1722;}
    .group h3 {margin:0 0 8px;font-size:14px;}
    label {font-size:12px;color:var(--muted);display:block;margin:6px 0 4px;}
    input[type="text"], select {width:100%;background:#0b1220;border:1px solid var(--border);border-radius:8px;color:var(--text);padding:8px;}
    input[type="file"] {width:100%;}
    button {background:var(--accent);border:none;color:#00131f;padding:10px 12px;border-radius:10px;font-weight:700;cursor:pointer;}
    button.secondary {background:#1c2635;color:var(--text);border:1px solid var(--border);}
    .row {display:grid;grid-template-columns:1fr 1fr;gap:8px;}
    .pill {display:inline-flex;gap:6px;align-items:center;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#0c1522;color:var(--muted);font-size:11px;}
    .legend {position:absolute;bottom:12px;left:12px;background:#0c1420;border:1px solid var(--border);border-radius:10px;padding:10px;color:#cfe7ff;font-size:12px;z-index:9999;box-shadow:0 2px 6px rgba(0,0,0,0.4);}
    .legend .bar {height:10px;background:linear-gradient(90deg,#1b4,#2a5,#4c7,#8ba,#c9c,#f77);border-radius:6px;margin:6px 0;}
    .metrics {font-family:ui-monospace,monospace;font-size:12px;}
    .foot {position:sticky;bottom:0;background:#0d141c;border-top:1px solid var(--border);padding:10px;display:flex;gap:8px;flex-wrap:wrap;}
    .hint {font-size:11px;color:#a8c3da;}
    a {color:#7ed0ff;}
  </style>
</head>
<body>
  <div class="layout">
    <header>
      <h1>Firefly Habitat Zoning <span class="mini">— GIS + Random Forest</span></h1>
      <div class="pill">Status: <span id="status">idle</span></div>
    </header>
    <aside>
      <div class="panel">
        <div class="group">
          <h3>1) Upload Training CSV</h3>
          <input id="trainFile" type="file" accept=".csv,.txt"/>
          <label for="labelCol">Label column</label>
          <input id="labelCol" type="text" value="presence"/>
          <label for="featureCols">Feature columns</label>
          <input id="featureCols" type="text" value="ndvi,canopy,dist_water,salinity"/>
          <div class="row"><button id="btnPreview">Preview</button><button id="btnTrain">Train RF</button></div>
          <pre id="previewBox" class="metrics"></pre>
        </div>
        <div class="group">
          <h3>2) Upload Prediction GeoJSON</h3>
          <input id="predictFile" type="file" accept=".geojson,.json"/>
          <label for="predIdCol">ID property</label>
          <input id="predIdCol" type="text" placeholder="e.g. cell_id"/>
          <div class="row"><button id="btnPredict" class="secondary">Run Prediction</button><button id="btnExport" class="secondary">Export GeoJSON</button></div>
          <pre id="predictStats" class="metrics"></pre>
        </div>
        <div class="group">
          <h3>3) Styling</h3>
          <label for="paletteSel">Palette</label>
          <select id="paletteSel"><option value="viridis">Viridis</option><option value="red">Red</option><option value="blue">Blue</option><option value="green">Green</option></select>
          <label for="threshold">Threshold</label>
          <input id="threshold" type="text" value="0.5"/>
          <button id="btnRecolor" class="secondary">Recolor Layer</button>
        </div>
        <div class="foot">
          <span class="pill">RF trees: <span id="rfTrees">100</span></span>
          <span class="pill">Max depth: <span id="rfDepth">10</span></span>
          <button id="btnParams" class="secondary">Tune Params</button>
          <button id="btnClear" class="secondary">Clear Map</button>
        </div>
      </div>
    </aside>
    <main>
      <div id="map"></div>
      <div class="legend" id="legend">
        <b>Predicted Suitability</b> (0–1)
        <div class="bar"></div>
        <div id="metricBox" class="metrics">—</div>
      </div>
    </main>
  </div>

<script>
(function(){
  const map = L.map('map').setView([-2.0,111.0],5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(map);
  const layers={training:L.layerGroup().addTo(map),prediction:L.layerGroup().addTo(map)};
  const state={trainRows:[],featureCols:[],labelCol:'presence',forest:null,rfParams:{nEstimators:100,maxDepth:10,seed:42},predictGeoJSON:null,predictResult:null};
  const $=id=>document.getElementById(id);
  function setStatus(s){$('status').textContent=s;}
  function csvToMarkers(rows){layers.training.clearLayers();rows.slice(0,1000).forEach(r=>{const lat=parseFloat(r.lat),lon=parseFloat(r.lon);if(Number.isFinite(lat)&&Number.isFinite(lon)){const c=r[state.labelCol]==1?'#22c55e':'#ef4444';L.circleMarker([lat,lon],{radius:4,color:c,weight:1,fillOpacity:0.8}).addTo(layers.training);}});try{map.fitBounds(layers.training.getBounds(),{padding:[12,12]});}catch(e){} }
  async function parseCSV(file){return new Promise((res,rej)=>{Papa.parse(file,{header:true,dynamicTyping:true,skipEmptyLines:true,complete:r=>res(r.data),error:rej});});}
  function holdoutSplit(rows,labelCol,testRatio=0.2){const pos=rows.filter(r=>Number(r[labelCol])===1);const neg=rows.filter(r=>Number(r[labelCol])===0);function split(a){const nTest=Math.floor(a.length*testRatio);const s=a.slice().sort(()=>Math.random()-0.5);return{train:s.slice(nTest),test:s.slice(0,nTest)}}const A=split(pos),B=split(neg);return{train:A.train.concat(B.train),test:A.test.concat(B.test)}}
  function buildXY(rows,cols,label){const X=[],y=[];for(const r of rows){const v=cols.map(c=>+r[c]);if(v.every(Number.isFinite)){X.push(v);y.push(+r[label]);}}return{X,y}}
  function accuracy(yT,yP){let m=0;for(let i=0;i<yT.length;i++)if(yT[i]===yP[i])m++;return yT.length?m/yT.length:0;}
  function probToColor(p){const t=Math.max(0,Math.min(1,p));const r=Math.round(255*t),g=Math.round(200*(1-t)),b=120;return`rgb(${r},${g},${b})`;}
  $('btnPreview').onclick=async()=>{const f=$('trainFile').files[0];if(!f)return alert('Select CSV');setStatus('Parsing…');state.labelCol=$('labelCol').value.trim();state.featureCols=$('featureCols').value.split(',').map(x=>x.trim());const rows=await parseCSV(f);state.trainRows=rows;csvToMarkers(rows);$('previewBox').textContent=`Rows:${rows.length}\nFeatures:${state.featureCols.join(', ')}`;setStatus('ready');};
  $('btnTrain').onclick=()=>{if(!state.trainRows.length)return alert('Preview first');const s=holdoutSplit(state.trainRows,state.labelCol);const tr=buildXY(s.train,state.featureCols,state.labelCol);const te=buildXY(s.test,state.featureCols,state.labelCol);const RF=ML.RandomForestClassifier;const rf=new RF({nEstimators:state.rfParams.nEstimators,maxDepth:state.rfParams.maxDepth,seed:state.rfParams.seed});rf.train(tr.X,tr.y);const yP=rf.predict(te.X);$('previewBox').textContent+=`\nAccuracy ${(accuracy(te.y,yP)*100).toFixed(1)}%`;state.forest=rf;setStatus('trained');};
  $('btnPredict').onclick=async()=>{if(!state.forest)return alert('Train model first');const f=$('predictFile').files[0];if(!f)return alert('Select GeoJSON');const gj=JSON.parse(await f.text());gj.features.forEach(ft=>{const pr=ft.properties||{};const vec=state.featureCols.map(c=>+pr[c]);if(vec.every(Number.isFinite)){const prob=state.forest.predictProbabilities([vec])[0][1];pr._rf_prob=prob;pr._rf_class=prob>=0.5?1:0;}ft.properties=pr;});state.predictResult=gj;layers.prediction.clearLayers();L.geoJSON(gj,{style:f=>({color:probToColor(f.properties._rf_prob||0.5),weight:1,fillOpacity:0.6})}).addTo(layers.prediction);setStatus('predicted');};
  $('btnExport').onclick=()=>{if(!state.predictResult)return alert('No result');const a=document.createElement('a');a.href='data:application/json,'+encodeURIComponent(JSON.stringify(state.predictResult));a.download='firefly_suitability.geojson';a.click();};
  map.on('mousemove',e=>$('metricBox').textContent=`${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`);
})();
</script>
</body>
</html>
